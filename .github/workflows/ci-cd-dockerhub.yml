name: CI-CD DockerHub + ArgoCD (GitOps)

on:
  push:
    branches:
      - main
    paths:
      - "src/"
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has-changes: ${{ steps.detect.outputs.has-changes }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect services
        id: detect
        run: |
          SERVICES=("ui" "catalog" "cart" "checkout" "orders")
          CHANGED=()

          for svc in "${SERVICES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/$svc/" || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              CHANGED+=("$svc")
            fi
          done

          if [ ${#CHANGED[@]} -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          MATRIX=$(printf '"%s",' "${CHANGED[@]}" | sed 's/,$//')
          echo "matrix={\"service\":[${MATRIX}]}" >> $GITHUB_OUTPUT
          echo "has-changes=true" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build & Deploy ${{ matrix.service }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    permissions:
      contents: write

    steps:
      # ðŸ”¹ Checkout MAIN (for code)
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      # ðŸ”¹ Image tag
      - name: Set image tag
        run: |
          TAG="$(git rev-parse --short HEAD)-${GITHUB_RUN_NUMBER}"
          echo "IMAGE_TAG=${TAG}" >> $GITHUB_ENV

      # ðŸ”¹ DockerHub login
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ðŸ”¹ Build & push image
      - name: Build & push image
        run: |
          SERVICE=${{ matrix.service }}
          IMAGE="yogeshverma08/retail-store-${SERVICE}"

          docker build -t ${IMAGE}:${IMAGE_TAG} src/${SERVICE}
          docker push ${IMAGE}:${IMAGE_TAG}

      # ðŸ”¹ Checkout GITOPS branch
      - name: Checkout gitops branch
        uses: actions/checkout@v4
        with:
          ref: gitops

      # ðŸ”¹ Update Helm values.yaml (ONLY gitops)
      - name: Update Helm values
        run: |
          SERVICE=${{ matrix.service }}
          VALUES="src/${SERVICE}/chart/values.yaml"

          sed -i "s|repository:.*|repository: yogeshverma08/retail-store-${SERVICE}|" ${VALUES}
          sed -i "s|tag:.*|tag: \"${IMAGE_TAG}\"|" ${VALUES}

      # ðŸ”¹ Commit & push to gitops
      - name: Commit Helm changes (gitops)
        run: |
          SERVICE=${{ matrix.service }}

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add src/${SERVICE}/chart/values.yaml
          git commit -m "ci(${SERVICE}): deploy image ${IMAGE_TAG}" || echo "No changes"
          git push origin gitops
